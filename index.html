<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script>
			//get the LOGIN key from the MASTER key
			function getLogin(master, redirect) {
				$.ajax({
					type: 'get',
					url: 'https://www.rlsmart.net/webservices/realsmart_access_server.php?method=getToken&arg1=' + master,
					dataType: 'xml',
					success: function(data, textStatus, jqXHR){
						var key = $(data).find('response')[0];
						var login = "https://www.rlsmart.net/sso/cloud/welcome_token.php?returnUrl=https%3A%2F%2Frlsmart.net%2Fmain%2F&token=" + $(key).text();
						$("#login").html('Click here to login (or copy it...)')

						if(redirect){
							$(location).attr("href", login);
						} else {
							$("#login").attr('href', login);
						}
					}
				});
			}

			//get the MASTER key
			function getMaster(redirect) {
				$.ajax({
					type: 'post',
					url: 'http://www.rlsmart.net/api-rs2/member/auth/login',
					dataType: 'json',
					data: {
						short_code: $('#sso_shortcode').val(),
						username: $('#sso_login_username').val(),
						password: $('#sso_login_password').val()
					},
					success: function(data, textStatus, jqXHR){
						if(data.error == false){
							$("#master").html(data.member.hash_key);
							getLogin(data.member.hash_key, redirect);
						}else{
							alert("Something happened. Are you connected to the internet, or did you remember your password?");
						}
					}
				});
			}

			// Login Submit
			$(document).on("click", "#sso_login_submit", function(event){
				getMaster(true);
			});

			// Get master
			$(document).on("click", "#sso_get_master", function(event){
				getMaster(false);
			});

			//auto login with master
			$(document).on("click", "#sso_master_submit", function(event){
				getLogin($('#sso_master_id').val(), true);
			});

			//get login url with master
			$(document).on("click", "#sso_master_submit_url", function(event){
				getLogin($('#sso_master_id').val(), false);
			});
		</script>
		<style>
			* {
				font-family: Arial, sans-serif
			}
			
			#disclaimer {
				font-family: "Ubuntu Mono", Courier, monospace;
			}
		</style>
	</head>
	<body>
		<h1>realsmart automatic logon system</h1>
		<p>Insert details</p>
		<input type="text" name="short_code" id="sso_shortcode" value="" placeholder="School short code"><br>
		<input type="text" name="username" id="sso_login_username" value="" placeholder="Enter your realsmart username"><br>
		<input type="password" name="password" id="sso_login_password" value="" placeholder="Enter your password"><br>
		<input type="submit" name="login" id="sso_login_submit" value="Login to realsmart with user details"><br>
		<input type="submit" name="login" id="sso_get_master" value="Get master code">
		<br><br>
		<input type="text" name="masterid" id="sso_master_id" value="" placeholder="Insert master ID here (if known)"><br>
		<input type="submit" name="login" id="sso_master_submit" value="Login to realsmart with master ID"><br>
		<input type="submit" name="login" id="sso_master_submit_url" value="Get Login URL">
		<br><br>
		<p id="master"></p>
		<a id="login"></a>
		<hr>
		<i>moustacheminer.com - Copyright 2017</i>
		<p id="disclaimer">
			rlsmart-login Master Code Identifier<br>
			Copyright (C) 2017  moustacheminer.com<br>
			<br>
			This program is free software: you can redistribute it and/or modify<br>
			it under the terms of the GNU General Public License as published by<br>
			the Free Software Foundation, either version 3 of the License, or<br>
			(at your option) any later version.<br>
			<br>
			This program is distributed in the hope that it will be useful,<br>
			but WITHOUT ANY WARRANTY; without even the implied warranty of<br>
			MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br>
			GNU General Public License for more details.<br>
			<br>
			You should have received a copy of the GNU General Public License<br>
			along with this program.  If not, see <http://www.gnu.org/licenses/>.
		</p>
	</body>
</html>
